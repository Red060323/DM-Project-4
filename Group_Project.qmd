---
title: "Group Project"
author: "Kenza Redwane & Julie Decraemer"
format: 
  html:
    code-fold: true
---

```{r}
#| message: false
here::i_am("DM-Project-4.Rproj")
library(here)
library(vroom)
library(ggplot2)
theme_set(theme_bw())
```

## Data import

In the following three chunks of code we are reading the different csv files of our three datasets into different variables, respectively `drug_seizure`, `lethal_overdoses` and `education`.

```{r}
#| message: false
drug_seizure <- vroom(here("drug-consumption.csv"))
```

```{r}
#| message: false
lethal_overdoses <- vroom(here("lethal-overdoses.csv"))
```

```{r}
#| message: false
education <- vroom(here("education.csv"))
```

Just below, we implemented a first cleaning of the `education` variable, which we called `education_preclean`. The goal was first to remove the empty columns, and renaming the remaining ones for clarity and usability.

```{r}
#| message: false
library(tidyverse)
library(readr)
library(knitr)
library(kableExtra)
education <- vroom(here("education.csv"))

education_clean <- education %>%
  slice(8:(n() - 3))%>%  

select(-c(3, 4, 6, 7, 9, 10, 12, 13, 15, 16, 18, 19, 21, 22, 24, 25, 
            27, 28, 30, 31, 33, 34, 36, 37, 39, 40, 42, 43)) %>%
rename(
  states = "Table 104.80. Percentage of persons 18 to 24 years old and age 25 and over. by educational attainment and state or jurisdiction: 2012 and 2022",
  less24years_highschool_2012 = "...2",
    less24years_highschool_2022 = "...5",
    years25_LessHighSchool_2012 = "...8",
    years25_LessHighSchool_2022 = "...11",
    years25_moreHighSchool_2012 = "...14",
    years25_moreHighSchool_2022 = "...17",
    years25_bachelor_higher_2012 = "...20",
    years25_bachelor_higher_2022 = "...23",
    years25_bachelor_2012 = "...26",
    years25_bachelor_2022 = "...29",
    years25_graduate_2012 = "...32",
    years25_graduate_2022 = "...35",
    years25_college_2012 = "...38",
    years25_college_2022 = "...41"
  ) 

kable(education_clean %>% slice(1:3), caption = "Excerpt of the first 3 rows of education_clean")
```

```{=html}
<style>
caption {
  text-align: left;
}
</style>
```
## Description of the files

**Link to our github project:** <a href="https://github.com/Kenz203/DM-Project-4" target="_blank">DM-Project-4</a> <br>

**1) Dataset about drug seizures in the United States** <br> <a href="https://www.cbp.gov/document/stats/nationwide-drug-seizures" target="_blank">Link to the website of the dataset</a> <br> With this link you must be redirected to the website of the *U.S. Customs and Border Protection*. Under the title "Dashboard dataset", you can click on the second file called "FY21 - FY24 Nationwide Drug Seizures" and it will download directly the file in csv.

```{r}
summary_table_1<- tibble(
  "  " = c(
    "**Topic**",
    "**Source information**",
    "**Rows**",
    "**Columns**",
    "**Key Variables**",
    "**Missing Values (%)**"
  ),
  " " = c(
    "Dataset about the seizures of different drugs across the United States from 2021 to 2024.",
    "The Nationwide Drug Seizures data was taken from the U.S. Customs and Border Protection. CBP is a federal agency under the Department of Homeland Security, it is responsible for  managing and making sure the nation's borders are secured, including land, sea, and air entry points. Its mission is to protect the United States from threats such as illegal immigration, smuggling, and terrorism while making trade and travel easy. CBP uses advanced technologies, intelligence-driven strategies, and highly trained employees to detect and prevent the trafficking of illegal drugs. The agency collaborates with domestic and international partners to try to destroy drug supply chains and criminal organizations. The dataset we chose includes statistics on the types, quantities, and locations of drugs seized by CBP. This data is regularly updated and reflects CBP's efforts in combating this challenge of drug smuggling.",
    nrow(drug_seizure),
    ncol(drug_seizure),
    "For each year from 2021 to 2024 (subdivided by months) and for each state (identified with their offices), we have the quantity in lbs of drugs seized (such as Marijuana, Cocaine, Fentanyl, etc) as well as the number of seizure events, both of which we will use as indicators of the level of drugs consumption in each state.",
    round(sum(is.na(drug_seizure)) / (nrow(drug_seizure) * ncol(drug_seizure)) * 100, 2)
  )
)

kable(summary_table_1, caption = "Summary of the Drug Seizures Dataset:", escape = FALSE)
```

<br>

**2) Dataset about drug overdose mortality in the United States** <br> <a href="https://www.cdc.gov/nchs/pressroom/sosmap/drug_poisoning_mortality/drug_poisoning.htm" target="_blank">Link to the website of the dataset</a> <br> Once you clicked on the link, you can scroll down and you will find, below the table, a link to directly download the data set in CSV.

```{r}
summary_table_2<- tibble(
  "  " = c(
    "**Topic**",
    "**Source information**",
    "**Rows**",
    "**Columns**",
    "**Key Variables**",
    "**Missing Values (%)**"
  ),
  " " = c(
    "Dataset about drug poisoning mortality rates across the United States from 1999 to 2022",
    "We found the Drug Poisoning Mortality dataset on the Centers for Disease Control and Prevention (CDC) website. The CDC is a national public health agency under the Department of Health and Human Services. Its missions are to protect public health by conducting critical research, provide reliable health information, and manage health emergencies (for example, during the COVID-19 pandemic, the CDC played a huge role by coordinating the national response by providing guidelines for prevention, conducting research on the virus, distributing vaccines, and offering critical health data to inform public policy and protect communities). The agency works to prevent disease outbreaks, promote health equity, and advance the overall well-being of the population. This dataset highlights trends in drug-related deaths and helps policymakers, researchers, and public health officials address the growing opioid crisis and other drug-related challenges.",
    nrow(lethal_overdoses),
    ncol(lethal_overdoses),
    "For each year from 1999 to 2022 and for each state, we have the overdose death rate as well as the the number of deaths per 100,000 total population.",
    round(sum(is.na(lethal_overdoses)) / (nrow(lethal_overdoses) * ncol(lethal_overdoses)) * 100, 2)
  )
)

kable(summary_table_2, caption = "Summary of the Drug Overdose Mortality Dataset:", escape = FALSE)
```

<br>

**3) Dataset about education levels accross the United States** <br> <a href="https://nces.ed.gov/programs/digest/d23/tables/dt23_104.80.asp" target="_blank">Link to the dataset</a> <br>

```{r}
summary_table_3 <- tibble(
  "  " = c(
    "**Topic**",
    "**Source information**",
    "**Rows**",
    "**Columns**",
    "**Key Variables**",
    "**Missing Values (%)**"
  ),
  " " = c(
    "Dataset about educational attainment in the US (2012-2022)",
    "The National Center for Education Statistics (NCES) is a federal agency that operates under the U.S. Department of Education. Its purpose is to gather, analyze, and share data about education across the United States, from early childhood to higher education. The NCES plays a critical role in providing accurate, reliable, and up-to-date information to help people better understand how the education system functions and how it affects students, teachers, and communities. One of the main goals of the NCES is to support decision-making by providing data that policymakers, educators, and researchers can use to improve education. Its work includes collecting statistics on topics such as student enrollment, academic performance, school funding, and teacher employment. This information helps government officials and school leaders make informed choices about funding allocation, program development, and education reforms. By publishing detailed reports and datasets, the NCES allows educators and researchers to analyze trends, identify gaps, and evaluate the fairness and efficiency of school systems. Its data also sheds light on important issues like whether public school funding is being used effectively and whether all students have equal access to educational resources. Through its efforts, the NCES helps improve the quality of education and ensures that learning opportunities are fair and accessible for everyone.",
    nrow(education_clean),
    ncol(education_clean),
    "For each state, we have the proportion of people under 24 who were high school completers in years 2012 and 2022, the proportion of people of age 25+ who have not completed their secondary education, as well as those who have graduated from high school, those who got a bachelor's degree and those who got a graduate degree, all those both for the years 2012 and 2022.",
    round(sum(is.na(education_clean)) / (nrow(education_clean) * ncol(education_clean)) * 100, 2)
  )
)

kable(summary_table_3, caption = "Summary of the Education Dataset:", escape = FALSE)
```

## Progressive Cleaning and Graphical Visualization

**The first steps of cleaning just below are done on the education data set**. We realized that the name of the column variables were not properly aligned with their respective values compared to the initial data set in xlsx format. Thus, we had to change them. After that, we removed column 12 since this was not useful for our analysis, the latest was about people who did associate degrees. The second step of cleaning on the education dataset was to remove the column that concerns the year 2012 since our analysis is focused on the year 2022 only.

```{r}
# Rename specific columns and remove column 12
education_clean <- education_clean %>%
  rename(
    # Specify new names for the columns
    `years25_atleast_highschool_2012` = 5,
    `years25_total_bachelor+_2012` = 6,
    `years25_bachelor_2012` = 7,
    `years25_graduate_2012` = 8,
    `years25_LessHighSchool_2022` = 9,
    `years25_atleast_highschool_2022` = 10,
    `years25_onlyhighschool_2022` = 11,
    `useless` = 12,
    `years25_total_bachelor+_2022` = 13,
    `years25_bachelor_2022` = 14,
    `years25_graduate_2022` = 15
  )

# Remove useless columns as well as columns on the year 2012
education_clean <- education_clean %>%
  select(-useless, -matches("2012"))

# Sample of the cleaned education data set
kable(
  head(education_clean, 3),
  escape = FALSE
)
```

We changed the names of the states by their codes, still in the education data set and we got rid of the observation about other jurisdictions as we don't have any information available about these:

```{r}
state_name <- unique(education_clean$states) # Extraction of unique states' names

state_codes <- data.frame(
  state_name = state_name,
  state_code = c("USA", "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", 
                 "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
                 "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", 
                 "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", 
                 "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY", "OTHER JURISDICTIONS", "PR")
)

education_clean <- education_clean %>%
  left_join(state_codes, by = c("states" = "state_name")) %>%  # Jointure by states names
  mutate(states = state_code) %>%  # Replace names by the codes
  filter(states != "OTHER JURISDICTIONS") %>%  # Remove unwanted rows
  select(-state_code)

kable(
  head(education_clean, 3),
  escape = FALSE
)

```
<br>
In the following, we proceed to the **cleaning of the data set about drug seizure** that we've already imported. First, we kept only 2022 as this is the only year which we will focus our analysis on, thus we removed all other years.

```{r}
#| message: false
drug_seizure <- drug_seizure %>%
  filter(FY == 2022)%>%
  rename(states = `Area of Responsibility`) 

kable(
  head(drug_seizure, 3),
  escape = FALSE
)
```
Now, the goal is to change the values in the variable `states` of the drug seizures data set because here they are organized in offices.
```{r}
# Extract unique values from the 'states' column of the drug seizures data set
offices_ds <- unique(drug_seizure$states)

# Modifying the states values with the codes of the latest
ds_offices_codes <- data.frame(
  offices = offices_ds,
  codes = c(
    "GA", "MD", "IL", "TX", "CA", "FL", "LA", "NY", "INTL", "CA", "PR", "FL", 
    "MA", "NY", "MI", "WA", "OR", "TX", "TX", "CA", "AZ", "FL", "PR", "WA", "NY", 
    "MI", "ME", "WA", "VT", "TX", "TX", "CA", "TX", "TX", "TX", "CA", "AZ", "AZ", 
    "MT", "ND", "LA"
  )
)

# Column replacement
drug_seizure <- drug_seizure %>%
  left_join(ds_offices_codes, by = c("states" = "offices")) %>%  # Joining by 'offices'
  mutate(states = ifelse(!is.na(codes), codes, states)) %>%
  select(-codes)

kable(
  head(drug_seizure, 3),
  escape = FALSE
)
```

#### Figure 1: The number of seizures per drug in the USA.

```{r}
#| message: false
library(ggplot2)
library(plotly)

# Summary of the seizures by drug type
drug_summary <- drug_seizure %>%
  group_by(`Drug Type`) %>%
  summarise(
    Total_Count = sum(`Count of Event`, na.rm = TRUE)  # Somme des valeurs
  )

# Creation of the graphic
drug_plot <- ggplot(drug_summary, aes(
  x = reorder(`Drug Type`, Total_Count),
  y = Total_Count,
  text = paste("Drug Type:", `Drug Type`, "<br>Count:", Total_Count)
)) +
  geom_col(fill = "darkorange", alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Number of seizures per drug",
    x = "Type of drug",
    y = "Number of seizures"
  ) +
  theme_minimal()

ggplotly(drug_plot, tooltip = "text")

```
#### Figure 2: Quantity seized per drug in the USA.
```{r}
# Summary of the seizures by drug type
drug_summary_2 <- drug_seizure %>%
  group_by(`Drug Type`) %>%
  summarise(
    Total_Quantity = sum(`Sum Qty (lbs)`, na.rm = TRUE)  
  )

# Graph creation
drug_plot <- ggplot(drug_summary_2, aes(
  x = reorder(`Drug Type`, Total_Quantity),
  y = Total_Quantity,
  text = paste("Drug Type:", `Drug Type`, "<br>Total Quantity (lbs):", Total_Quantity)  # Texte pour le tooltip
)) +
  geom_col(fill = "darkorange", alpha = 0.8) + 
  coord_flip() +
  labs(
    title = "Quantity of drugs seized per type (lbs)",
    x = "Type of drug",
    y = "Total quantity seized (lbs)"
  ) +
  theme_minimal()

ggplotly(drug_plot, tooltip = "text")
```

<br>
Continuing with the cleaning of the data set about drug seizure, we keep only the drug type "Fentanyl" as it is the core of our research focus:
```{r}
# Filter for only Fentanyl drug type
drug_seizure <- drug_seizure %>%
  filter(`Drug Type` == "Fentanyl")

# Display a sample of the filtered data
kable(
  head(drug_seizure, 3),
  escape = FALSE
)
```
In the next chunk, we finish the cleaning of the data set about drug seizure, we first get rid of the columns that are useless for our analysis. The followings are the `Component` variable (which corresponds to the office in which the operations have been conducted), which we are not interested in, then, the `Region` variable as well as the `Land filter` variable. The last two are not important for our analysis because we won't focus on the differences inside each states but between each states and the variable `Region` gives information about the region of the offices, not of the states. Then, we perform data summarization by first aggregating the data by states, calculating the total number of events (Count of Event) and the total quantity of drugs seized (Sum Qty (lbs)) for each state. 
```{r}
# Deleting useless variables (columns)
drug_seizure <- drug_seizure %>%
  select(-Region, -`Land Filter`, -Component)

# Exclude the state "INTL" as it is not a state
drug_seizure <- drug_seizure %>%
  filter(states != "INTL")

# Agregating data by states
drug_seizure_clean <- drug_seizure %>%
  group_by(states) %>%
  summarise(
    total_events = sum(`Count of Event`, na.rm = TRUE),
    total_quantity = sum(`Sum Qty (lbs)`, na.rm = TRUE)
  ) %>%
  ungroup()

# Print the result
kable(
  head(drug_seizure_clean, 3),
  col.names = c("State", "Total Events", "Total Quantity"),
  caption = "Summary of Fentanyl Seizures by State"
)
```

#### Figure 3 : The number of seizures of Fentanyl only, per state in the USA.

```{r}
library(ggplot2)
library(plotly)

# Graph's creation with ggplot2 library
fentanyl_plot_nbr <- ggplot(drug_seizure_clean, aes(
  x = reorder(states, total_events),  # RÃ©organiser par nombre de saisies
  y = total_events,
  text = paste("State:", `states`, "<br>Seizures of Fentanyl:", total_events)
)) +
  geom_col(fill = "red", alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Number of seizures of Fentanyl",
    x = "State",
    y = "Number of seizures"
  ) +
  theme_minimal()

# Convert into an interactive grphical representation with plotly
ggplotly(fentanyl_plot_nbr, tooltip = "text")

```
#### Figure 4: Quantity of fentanyl seized per state in the USA
```{r}
# Graph's creation with ggplot2 library
fentanyl_plot_quantity <- ggplot(drug_seizure_clean, aes(
  x = reorder(states, total_quantity),  # Reorder states by total quantity
  y = total_quantity,  # Use total quantity on y-axis
  text = paste("State:", states, "<br>Quantity of Fentanyl (lbs):", total_quantity)  # Tooltip text
)) +
  geom_col(fill = "blue", alpha = 0.8) +  # Blue bars for quantity
  coord_flip() +  # Flip coordinates
  labs(
    title = "Quantity of Fentanyl seized per state (lbs)",
    x = "State",
    y = "Total quantity seized (lbs)"
  ) +
  theme_minimal()

# Convert into an interactive graphical representation with plotly
ggplotly(fentanyl_plot_quantity, tooltip = "text")
```

<br>
Below is the **cleaning of the lethal overdoses data set**. First of all, we filter in order to keep only the year 2022. then, we remove the column URL, which we won't use for our analysis and finally, we change the code for "District of Columbia" with its code.
```{r}
#| message: false
lethal_overdoses_clean <- lethal_overdoses %>%
  filter(YEAR == 2022) %>%  # Keep only data for the year 2022
  rename(states = STATE) %>%  # Rename the 'STATE' column to 'states'
  select(-URL) %>%  # Remove the 'URL' column
  mutate(states = if_else(states == "District of Columbia", "DC", states))

kable(
  head(lethal_overdoses_clean, 3),
  caption = "Summary of the cleaned lethal overdoses data set read as a variable: ",
  escape = FALSE
)
```

#### Figure 5: The rate of overdoses per state during 2022.

```{r}

```

#### Figure 6: 

```{r}

```
