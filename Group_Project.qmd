---
title: "Group Project"
author: "Kenza Redwane & Julie Decraemer"
format: 
  html:
    code-fold: true
---

```{r}
#| message: false
here::i_am("DM-Project-4.Rproj")
library(here)
library(vroom)
library(ggplot2)
theme_set(theme_bw())
```

## Data import

In the following three chunks of code we are reading the different csv files of our three datasets into different variables, respectively `drug_seizure`, `lethal_overdoses` and `education`.

```{r}
#| message: false
drug_seizure <- vroom(here("drug-consumption.csv"))
```

```{r}
#| message: false
lethal_overdoses <- vroom(here("lethal-overdoses.csv"))
```

```{r}
#| message: false
education <- vroom(here("education.csv"))
```

Just below, we implemented a first cleaning of the `education` variable, which we called `education_clean`. The goal was first to remove the empty columns, and renaming the remaining ones for clarity and usability.

```{r}
#| message: false
library(tidyverse)
library(readr)
library(knitr)
library(kableExtra)
education <- vroom(here("education.csv"))

education_clean <- education %>%
  slice(8:(n() - 3))%>%  

select(-c(3, 4, 6, 7, 9, 10, 12, 13, 15, 16, 18, 19, 21, 22, 24, 25, 
            27, 28, 30, 31, 33, 34, 36, 37, 39, 40, 42, 43)) %>%
rename(
  states = "Table 104.80. Percentage of persons 18 to 24 years old and age 25 and over. by educational attainment and state or jurisdiction: 2012 and 2022",
  less24years_highschool_2012 = "...2",
    less24years_highschool_2022 = "...5",
    years25_LessHighSchool_2012 = "...8",
    years25_LessHighSchool_2022 = "...11",
    years25_moreHighSchool_2012 = "...14",
    years25_moreHighSchool_2022 = "...17",
    years25_bachelor_higher_2012 = "...20",
    years25_bachelor_higher_2022 = "...23",
    years25_bachelor_2012 = "...26",
    years25_bachelor_2022 = "...29",
    years25_graduate_2012 = "...32",
    years25_graduate_2022 = "...35",
    years25_college_2012 = "...38",
    years25_college_2022 = "...41"
  ) 

kable(education_clean %>% slice(1:3), caption = "Excerpt of the first 3 rows of education_clean")
```

```{=html}
<style>
caption {
  text-align: left;
}
</style>
```
## Description of the files

**Link to our github project:** <a href="https://github.com/Kenz203/DM-Project-4" target="_blank">DM-Project-4</a> <br>

**1) Dataset about drug seizures in the United States** <br> <a href="https://www.cbp.gov/document/stats/nationwide-drug-seizures" target="_blank">Link to the website of the dataset</a> <br> With this link you must be redirected to the website of the *U.S. Customs and Border Protection*. Under the title "Dashboard dataset", you can click on the second file called "FY21 - FY24 Nationwide Drug Seizures" and it will download directly the file in csv.

```{r}
summary_table_1<- tibble(
  "  " = c(
    "**Topic**",
    "**Source information**",
    "**Rows**",
    "**Columns**",
    "**Key Variables**",
    "**Missing Values (%)**"
  ),
  " " = c(
    "Dataset about the seizures of different drugs across the United States from 2021 to 2024.",
    "The Nationwide Drug Seizures data was taken from the U.S. Customs and Border Protection. CBP is a federal agency under the Department of Homeland Security, it is responsible for  managing and making sure the nation's borders are secured, including land, sea, and air entry points. Its mission is to protect the United States from threats such as illegal immigration, smuggling, and terrorism while making trade and travel easy. CBP uses advanced technologies, intelligence-driven strategies, and highly trained employees to detect and prevent the trafficking of illegal drugs. The agency collaborates with domestic and international partners to try to destroy drug supply chains and criminal organizations. The dataset we chose includes statistics on the types, quantities, and locations of drugs seized by CBP. This data is regularly updated and reflects CBP's efforts in combating this challenge of drug smuggling.",
    nrow(drug_seizure),
    ncol(drug_seizure),
    "For each year from 2021 to 2024 (subdivided by months) and for each state (identified with their offices), we have the quantity in lbs of drugs seized (such as Marijuana, Cocaine, Fentanyl, etc) as well as the number of seizure events, both of which we will use as indicators of the level of drugs consumption in each state.",
    round(sum(is.na(drug_seizure)) / (nrow(drug_seizure) * ncol(drug_seizure)) * 100, 2)
  )
)

kable(summary_table_1, caption = "Summary of the Drug Seizures Dataset:", escape = FALSE)
```

<br>

**2) Dataset about drug overdose mortality in the United States** <br> <a href="https://www.cdc.gov/nchs/pressroom/sosmap/drug_poisoning_mortality/drug_poisoning.htm" target="_blank">Link to the website of the dataset</a> <br> Once you clicked on the link, you can scroll down and you will find, below the table, a link to directly download the data set in CSV.

```{r}
summary_table_2<- tibble(
  "  " = c(
    "**Topic**",
    "**Source information**",
    "**Rows**",
    "**Columns**",
    "**Key Variables**",
    "**Missing Values (%)**"
  ),
  " " = c(
    "Dataset about drug poisoning mortality rates across the United States from 1999 to 2022",
    "We found the Drug Poisoning Mortality dataset on the Centers for Disease Control and Prevention (CDC) website. The CDC is a national public health agency under the Department of Health and Human Services. Its missions are to protect public health by conducting critical research, provide reliable health information, and manage health emergencies (for example, during the COVID-19 pandemic, the CDC played a huge role by coordinating the national response by providing guidelines for prevention, conducting research on the virus, distributing vaccines, and offering critical health data to inform public policy and protect communities). The agency works to prevent disease outbreaks, promote health equity, and advance the overall well-being of the population. This dataset highlights trends in drug-related deaths and helps policymakers, researchers, and public health officials address the growing opioid crisis and other drug-related challenges.",
    nrow(lethal_overdoses),
    ncol(lethal_overdoses),
    "For each year from 1999 to 2022 and for each state, we have the overdose death rate as well as the the number of deaths because of overdose, both per 100,000 inhabitants",
    round(sum(is.na(lethal_overdoses)) / (nrow(lethal_overdoses) * ncol(lethal_overdoses)) * 100, 2)
  )
)

kable(summary_table_2, caption = "Summary of the Drug Overdose Mortality Dataset:", escape = FALSE)
```

<br>

**3) Dataset about education levels accross the United States** <br> <a href="https://nces.ed.gov/programs/digest/d23/tables/dt23_104.80.asp" target="_blank">Link to the dataset</a> <br>

```{r}
summary_table_3 <- tibble(
  "  " = c(
    "**Topic**",
    "**Source information**",
    "**Rows**",
    "**Columns**",
    "**Key Variables**",
    "**Missing Values (%)**"
  ),
  " " = c(
    "Dataset about educational attainment in the US (2012-2022)",
    "The National Center for Education Statistics (NCES) is a federal agency that operates under the U.S. Department of Education. Its purpose is to gather, analyze, and share data about education across the United States, from early childhood to higher education. The NCES plays a critical role in providing accurate, reliable, and up-to-date information to help people better understand how the education system functions and how it affects students, teachers, and communities. One of the main goals of the NCES is to support decision-making by providing data that policymakers, educators, and researchers can use to improve education. Its work includes collecting statistics on topics such as student enrollment, academic performance, school funding, and teacher employment. This information helps government officials and school leaders make informed choices about funding allocation, program development, and education reforms. By publishing detailed reports and datasets, the NCES allows educators and researchers to analyze trends, identify gaps, and evaluate the fairness and efficiency of school systems. Its data also sheds light on important issues like whether public school funding is being used effectively and whether all students have equal access to educational resources. Through its efforts, the NCES helps improve the quality of education and ensures that learning opportunities are fair and accessible for everyone.",
    nrow(education_clean),
    ncol(education_clean),
    "For each state, we have the number of people under 24 who were high school completers in years 2012 and 2022, the number of people of age 25+ who have not completed their secondary education, as well as those who have graduated from high school, those who got a bachelor's degree and those who got a graduate degree, all those both for the years 2012 and 2022.",
    round(sum(is.na(education_clean)) / (nrow(education_clean) * ncol(education_clean)) * 100, 2)
  )
)

kable(summary_table_3, caption = "Summary of the Education Dataset:", escape = FALSE)
```

## Cleaning

### Education Data Set

The first steps of cleaning just below are done on the education data set. We realized that the name of the column variables were not properly aligned with their respective values compared to the initial data set in xlsx format. Thus, we had to change them. After that, we removed column 12 since this was not useful for our analysis, the latest was about people who did associate degrees. The second step of cleaning on the education dataset was to remove the column that concerns the year 2012 since our analysis is focused on the year 2022 only. Then, we had to fix the fact that our numeric columns are stored as characters, likely due to the use of commas as decimal or thousand separators.

```{r}
# Rename specific columns and remove column 12
education_clean <- education_clean %>%
  rename(
    # Specify new names for the columns
    `years25_atleast_highschool_2012` = 5,
    `years25_total_bachelor+_2012` = 6,
    `years25_bachelor_2012` = 7,
    `years25_graduate_2012` = 8,
    `years25_LessHighSchool_2022` = 9,
    `years25_atleast_highschool_2022` = 10,
    `years25_onlyhighschool_2022` = 11,
    `useless` = 12,
    `years25_total_bachelor+_2022` = 13,
    `years25_bachelor_2022` = 14,
    `years25_graduate_2022` = 15
  )

# Remove useless columns as well as columns on the year 2012
education_clean <- education_clean %>%
  select(-useless, -matches("2012"))

education_clean <- education_clean %>%
  # Remove everything after the comma (including the comma) and the periods
  mutate(across(-states, ~ gsub(",.*", "", .))) %>%  # Remove the comma and everything after it
  mutate(across(-states, ~ gsub("\\.", "", .))) %>%  # Remove the dots
  # Convert to numeric
  mutate(across(-states, ~ as.numeric(.)))


# Sample of the cleaned education data set
kable(
  head(education_clean, 3),
  escape = FALSE
)
```

We changed the names of the states by their codes, still in the education data set and we got rid of the observation about other jurisdictions as we don't have any information available about these.

```{r}
state_name <- unique(education_clean$states) # Extraction of unique states' names

state_codes <- data.frame(
  state_name = state_name,
  state_code = c("USA", "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", 
                 "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
                 "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", 
                 "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", 
                 "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY", "OTHER JURISDICTIONS", "PR")
)

education_clean <- education_clean %>%
  left_join(state_codes, by = c("states" = "state_name")) %>%  # Jointure by states names
  mutate(states = state_code) %>%  # Replace names by the codes
  filter(states != "OTHER JURISDICTIONS") %>%  # Remove unwanted rows
  select(-state_code)

kable(
  head(education_clean, 3),
  escape = FALSE
)

```

### Drug Seizure Data Set

<br> In the following, we proceed to the cleaning of the data set about drug seizure that we've already imported. First, we kept only 2022 as this is the only year which we will focus our analysis on, thus we removed all other years.

```{r}
#| message: false
drug_seizure <- drug_seizure %>%
  filter(FY == 2022)%>%
  rename(states = `Area of Responsibility`) 

kable(
  head(drug_seizure, 3),
  escape = FALSE
)
```

Now, the goal is to change the values in the variable `states` of the drug seizures data set because here they are organized in offices.

```{r}
# Extract unique values from the 'states' column of the drug seizures data set
offices_ds <- unique(drug_seizure$states)

# Modifying the states values with the codes of the latest
ds_offices_codes <- data.frame(
  offices = offices_ds,
  codes = c(
    "GA", "MD", "IL", "TX", "CA", "FL", "LA", "NY", "INTL", "CA", "PR", "FL", 
    "MA", "NY", "MI", "WA", "OR", "TX", "TX", "CA", "AZ", "FL", "PR", "WA", "NY", 
    "MI", "ME", "WA", "VT", "TX", "TX", "CA", "TX", "TX", "TX", "CA", "AZ", "AZ", 
    "MT", "ND", "LA"
  )
)

# Column replacement
drug_seizure <- drug_seizure %>%
  left_join(ds_offices_codes, by = c("states" = "offices")) %>%  # Joining by 'offices'
  mutate(states = ifelse(!is.na(codes), codes, states)) %>%
  select(-codes)

kable(
  head(drug_seizure, 3),
  escape = FALSE
)
```

#### Figure 1: The number of seizures per drug in the USA.

```{r}
#| message: false
library(ggplot2)
library(plotly)

# Summary of the seizures by drug type
drug_summary <- drug_seizure %>%
  group_by(`Drug Type`) %>%
  summarise(
    Total_Count = sum(`Count of Event`, na.rm = TRUE)
  )

# Creation of the graphic
drug_plot <- ggplot(drug_summary, aes(
  x = reorder(`Drug Type`, Total_Count),
  y = Total_Count,
  text = paste("Drug Type:", `Drug Type`, "<br>Count:", Total_Count)
)) +
  geom_col(fill = "darkorange", alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Number of seizures per drug",
    x = "Type of drug",
    y = "Number of seizures"
  ) +
  theme_minimal()

ggplotly(drug_plot, tooltip = "text")
```

#### Figure 2: Quantity seized per drug in the USA.

```{r}
# Summary of the seizures by drug type
drug_summary_2 <- drug_seizure %>%
  group_by(`Drug Type`) %>%
  summarise(
    Total_Quantity = sum(`Sum Qty (lbs)`, na.rm = TRUE)  
  )

# Graph creation
drug_plot <- ggplot(drug_summary_2, aes(
  x = reorder(`Drug Type`, Total_Quantity),
  y = Total_Quantity,
  text = paste("Drug Type:", `Drug Type`, "<br>Total Quantity (lbs):", Total_Quantity)  # Text for the tooltip
)) +
  geom_col(fill = "darkorange", alpha = 0.8) + 
  coord_flip() +
  labs(
    title = "Quantity of drugs seized per type (lbs)",
    x = "Type of drug",
    y = "Total quantity seized (lbs)"
  ) +
  theme_minimal()

ggplotly(drug_plot, tooltip = "text")
```

<br> These two graphs highlight the quantity and events of drugs seized per type in the USA, showcasing methamphetamine, khat, and marijuana as the most seized drugs. While fentanyl accounts for a smaller proportion of the total quantity seized, its public health impact is disproportionately high due to its potency and contribution to overdose deaths. <br> <br> <br> Continuing with the cleaning of the data set about drug seizure, we keep only the drug type "Fentanyl" as it is the core of our research focus:

```{r}
# Filter for only Fentanyl drug type
drug_seizure <- drug_seizure %>%
  filter(`Drug Type` == "Fentanyl")

kable(
  head(drug_seizure, 3),
  escape = FALSE
)
```

In the next chunk, we finish the cleaning of the data set about drug seizure, we first get rid of the columns that are useless for our analysis. The followings are the `Component` variable (which corresponds to the office in which the operations have been conducted), which we are not interested in, then, the `Region` variable as well as the `Land filter` variable. The last two are not important for our analysis because we won't focus on the differences inside each states but between each states and the variable `Region` gives information about the region of the offices, not of the states. Then, we perform data summarization by first aggregating the data by states, calculating the total number of events (Count of Event) and the total quantity of drugs seized (Sum Qty (lbs)) for each state.

```{r}
# Deleting useless variables (columns)
drug_seizure <- drug_seizure %>%
  select(-Region, -`Land Filter`, -Component)

# Exclude the state "INTL" as it is not a state
drug_seizure <- drug_seizure %>%
  filter(states != "INTL")

# Agregating data by states
drug_seizure_clean <- drug_seizure %>%
  group_by(states) %>%
  summarise(
    total_events = sum(`Count of Event`, na.rm = TRUE),
    total_quantity = sum(`Sum Qty (lbs)`, na.rm = TRUE)
  ) %>%
  ungroup()

# Print the result
kable(
  head(drug_seizure_clean, 3),
  col.names = c("State", "Total Events", "Total Quantity"),
  caption = "Summary of Fentanyl Seizures by State"
)
```

Right below, I add a new observation called "USA" where each numeric column represents the mean of all corresponding values across the other states, providing a national-level summary for total events and quantities. The rest opf the script calculates the proportion of total_events and total_quantity for each state relative to the USA total (the "USA" row represents 100%) and adds two new variables, total_events_proportion and total_quantity_proportion, to the dataset. These new variables express each state's contribution as a percentage of the overall total.

```{r}
# Add a USA row with the averages of the numeric columns
drug_seizure_clean <- drug_seizure_clean %>%
 filter(states != "USA") %>% # Remove the current USA row if it exists
  bind_rows(
    drug_seizure_clean %>%
      summarise(
        across(
          where(is.numeric), 
          ~ sum(.x, na.rm = TRUE) # Sum all numeric columns
        ),
        states = "USA" # Add the "USA" state name
      )
  )

# Adding the proportion variables
drug_seizure_clean <- drug_seizure_clean %>%
  mutate(
    total_events_proportion = round((total_events / total_events[states == "USA"]) * 100, 2),
    total_quantity_proportion = round((total_quantity / total_quantity[states == "USA"]) * 100, 2)
  )

kable(
  head(drug_seizure_clean, 3),
  caption = "Drug seizure dataset with an additional row for USA (mean values):",
  escape = FALSE
)
```

### Lethal overdoses Data Set

<br> Below is the cleaning of the lethal overdoses data set. First of all, we filter in order to keep only the year 2022. then, we remove the column URL, which we won't use for our analysis and finally, we change the code for "District of Columbia" with its code.

```{r}
#| message: false
lethal_overdoses_clean <- lethal_overdoses %>%
  filter(YEAR == 2022) %>%  # Keep only data for the year 2022
  rename(states = STATE) %>%  # Rename the 'STATE' column to 'states'
  select(-URL, -YEAR) %>%  # Remove the 'URL' column
  mutate(states = if_else(states == "District of Columbia", "DC", states))

kable(
  head(lethal_overdoses_clean, 3),
  caption = "Summary of the cleaned lethal overdoses data set read as a variable: ",
  escape = FALSE
)
```

Here, we are again adding a USA observation that calculate the mean across all the states of all the variables of the data set:

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
lethal_overdoses_clean <- lethal_overdoses_clean %>%
  bind_rows(
    lethal_overdoses_clean %>%
      summarise(
        across(
          .cols = where(is.numeric) & !c("DEATHS"),
          .fns = mean,
          na.rm = TRUE
        ),
        RATE = round(mean(RATE, na.rm = TRUE), 2),
        DEATHS = sum(DEATHS),
        states = "USA" # Add the observation `USA`
      )
  )
```

```{r}
kable(
  head(lethal_overdoses_clean, 3),
  caption = "Lethal Overdoses dataset with an additional row for USA (mean values):",
  escape = FALSE
)
```

## Graphical Visualizations

#### Map of Education for the Graduated students in US

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
#| message: false
# Load necessary libraries
library(sf)
library(mapview)
library(dplyr)
library(rnaturalearth)
library(rnaturalearthhires)

# Load the geographical data of the United States
us_states <- ne_states(country = "United States of America", returnclass = "sf") %>%
  rename(states = postal)  # Harmonization of the columns for the jointure

# Jointure of the education data set with the geographical data of the USA
us_education <- us_states %>%
  left_join(education_clean, by = "states")  # Jointure via the harmonized column `states`

# Just checking if the jointure worked
glimpse(us_education)

# Creation of an interactive map with mapview
map_education <- mapview(
  us_education,
  zcol = "years25_graduate_2022",  # Column used for the color
  layer.name = "Graduate Education Population (in Million)",  # Name of the layer
  col.regions = viridis::viridis(100),  # Palette of colors
  legend = TRUE
)

# Apply a personalized palette
custom_palette <- c("#4daf4a", "#377eb8", "#ff7f00", "#984ea3", "#a65628")   

map_education <- mapview(
  us_education,
  zcol = "years25_graduate_2022",
  layer.name = "Graduate Education Population (in Million)",
  col.regions = custom_palette,
  legend = TRUE
)
```

```{r}
# Display the map
map_education
```

<u>Notice that by zooming on each state, you can see the name of it and this will be the case on all the maps</u> <br>

-   **Comments:**

    This graphic show that states with low levels of education, specially those in the southern U.S. (for istance Louisiana, Mississippi and Arkansas), correspondz to regions with moderately high quantities of drugs seized. Conversely, some states with a high level of education, such as California, also show significant seizures.

    This may be explained by their high population density and more developed infrastructure for detecting and monitoring drug trafficking, irrespective of education levels. Finally, anomalies emerge in states such as Texas and Arizona, which record significant seizures despite education levels that do not stand out. This situation could reflect their strategic role as transit zones, notably due to their proximity to borders, facilitating drug trafficking.

-   **Hypothesis based on Graphics:**

    We may have a potential link between education levels and the drug situation in some regions. In areas where the level of education is relatively low, this could be associated with higher consumption behaviors or an increased prevalence of drug trafficking. However, this relationship isn't universal, and highly dependent on factors such as demographics and regional specificities.

    On the other hand, well-educated states such as California or New York, which record significant seizures, do not necessarily reflect high consumption. Rather, these seizures could be the result of effective surveillance systems and infrastructures capable of intercepting drug trafficking, further highlighting their strategic role in the fight against this phenomenon.

#### Map of Drug Seizure in USA

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# The order of the steps and the steps themselves are the same as the ones we used for the education data set
library(sf)
library(mapview)
library(dplyr)
library(rnaturalearth)
library(rnaturalearthhires)

# Step 1
us_states <- ne_states(country = "United States of America", returnclass = "sf") %>%
  rename(states = postal) 

# Step 2
us_drug_seizure <- us_states %>%
  left_join(drug_seizure_clean, by = "states") 

# Step 3
glimpse(us_drug_seizure)

# Step 4:
map_drug_seizure <- mapview(
  us_drug_seizure,
  zcol = "total_quantity_proportion",
  layer.name = "Drug Seizure Quantity (lbs)",
  col.regions = custom_palette,
  legend = TRUE
  )  # Popup displaying the abbreviation and quantity

# Step 5:
custom_palette <- c("#4daf4a", "#377eb8", "#ff7f00", "#984ea3", "#a65628")  

```

```{r}
# Displaying the map
map_drug_seizure
```

-   **Comments:**

    This map illustrates the quantity of drugs seized (in pounds) by state in the United States. The data show significant variations between states. California and Arizona record the highest quantities, exceeding 7,000 pounds respectively. On the other hand, several states, notably Alaska, show unavailable data or negligible quantities. The disparities observed may reflect factors such as the importance of drug trafficking routes, the proximity of borders and the priorities of law enforcement in each region. Due to this lack of some information, our analysis will focus on comparing drug seizure quantities across specific regions, including the northern, southern, eastern, and western borders of the United States. This approach allows us to identify regional patterns despite the missing data.

#### Map of Lethal Overdoses in USA

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# The order of the steps and the steps themselves are the same as the ones we used for the education and the drug seizure data set
library(sf)
library(mapview)
library(dplyr)
library(rnaturalearth)
library(rnaturalearthhires)

# Step 1
us_states <- ne_states(country = "United States of America", returnclass = "sf")%>%
  rename(states = postal)

# Step 2
us_overdoses <- us_states %>%
  left_join(lethal_overdoses_clean, by = "states")  

# Step 3
glimpse(us_overdoses)

# Step 4
map_overdose <- mapview(
  us_overdoses,
  zcol = "RATE",             
  layer.name = "Overdoses Rate", 
  col.regions = viridis::viridis(100),  
  legend = TRUE
)

# Step 5
custom_palette <- c("#4daf4a", "#377eb8", "#ff7f00", "#984ea3")  

# Step 6
map_overdose <- mapview(
  us_overdoses,
  zcol = "RATE",
  layer.name = "Overdoses Rate",
  col.regions = custom_palette,
  legend = TRUE
)
```

```{r}
map_overdose
```

-   **Comments:**

    This graph shows overdose rates by state in 2022, with colors ranging from green (low rates) to red/purple (high rates). The highest rates are seen in states such as West Virginia, Tennessee, and Maryland, often exceeding 70 overdoses per 100,000 inhabitants, while the lowest rates are found mainly in western states, such as South Dakota or Nebrasaka, with values below 20. This distribution highlights a marked regional disparity in the U.S. overdose crisis. <br>

## Joining

```{r}
# Perform the inner join on the three datasets using the 'states' variable
joined_dataset <- drug_seizure_clean %>%
  inner_join(education_clean, by = "states") %>%
  inner_join(lethal_overdoses_clean, by = "states")

# View the resulting dataset
kable(
  head(joined_dataset, 3), 
  caption = "Final dataset: Combined information from all three datasets (states in common only)", 
  escape = FALSE
)
```

<br> The joining process combines our three datasets (`drug_seizure_clean`, `education_clean`, and `lethal_overdoses_clean`) by using the common variable `states`. An **inner join** was performed, ensuring that only states present in all three datasets are included in the final combined dataset. This ensures consistency and avoids missing data issues for the analysis. <br>

The resulting dataset contains the following variables: <br> <br> - **states**: Abbreviations for each state. <br> - **total_events**: Total number of drug seizure events. <br> - **total_quantity**: Total quantity of drugs seized (in pounds). <br> - **total_events_proportion**: The proportion of drug seizure events for each state relative to the USA. <br> - **total_quantity_proportion**: The proportion of drug quantity seized for each state relative to the USA. <br> - Additional **education-related variables** (e.g., levels of education attainment by age groups) <br> -**RATE and DEATHS**: Provide information about the overdose death rate as well as the the number of deaths because of overdose, both per 100,000 inhabitants for each state. <br>

This merged dataset facilitates comprehensive cross-sectional analysis, integrating drug seizures, education levels, and overdose metrics for the states in common.<br>

## Reaserch Question

The **fentanyl overdose crisis in the United States** represents a major <u>public health emergency</u>, exacerbated by economic, social, and cultural factors. In **2022**, this crisis reached a <u>critical point</u> and thus caught our attention for this research. That year was marked by a significant increase in fentanyl production in China and its distribution by Mexican cartels. This drug, often mixed with other substances to reduce costs, saw its consumption skyrocket. At the same time, post-COVID effects, such as depression and increased drug experimentation, worsened the crisis, particularly in poorer states, which were affected by high inflation and growing economic insecurity. <br><br> Focusing our analysis on 2022 not only highlights the pivotal nature of this year in the fentanyl crisis but also ensures **consistent metrics across all states**. This approach allows for <u>clearer and more straightforward</u> interpretation of results, avoiding the complexities introduced by multi-year, time-based effects. By centering our research on this critical year, we aim to uncover meaningful patterns and relationships that might otherwise be obscured. In examining these patterns, **education** levels emerge as a potentially <u>key factor in understanding regional disparities in this crisis</u>. Low education levels may limit access to information, exacerbate risky behaviors, and reduce socio-economic opportunities, thus increasing the vulnerability of populations to fentanyl use and overdoses. <br><br> Thus, our **research question** is formulated as follows: *“How do fentanyl overdose rates vary with education levels across different regions of the United States?”* More specifically, *“What is the relationship between education levels and fatal overdoses, and what regional disparities emerge from this?”* <br><br> Our objectives for this study would be:<br><br> - To analyze the relationship between education levels and fentanyl overdose rates in different states as well as the relationship between education levels and fentanyl consumption in different states.<br> - To statistically examine regional disparities, that is, whether regions with lower education levels are disproportionately affected by this crisis or not. <br> - To discuss contextual factors, such as economic conditions or access to healthcare, that could influence this relationship.<br><br>

To this end, we have formulated the following hypotheses:<br><br> **States with lower education levels have higher rates of fentanyl overdoses and seizures.** <br> **The relationship between fentanyl seizures and overdoses is more pronounced in less-educated states.** <br> **Contextual factors, such as economic conditions or public health infrastructure, modulate this relationship.**

## Description of Data Set

```{r}
data_description <- data.frame(
   Name = c(
    "Drug Seizures in the United States",
    "Drug overdose mortality in the United States",
    "Education Levels in the United States"
  ),
  Description = c(
    "It presents information about drug seizures between 2021 and 2024, in the United States, from the US Customs and Border Protection. Indeed, data includes variables on the types, quantities (in pounds) and locations of drugs that have been seized; it reflects the efforts of authorities to combat drug trafficking. Indeed, we used drug seizure data as an indicator of drug consumption, a coherent decision as it contains only the fentanyl intended for misuse and excludes the medical use of the latest. All variables are well formatted with no missing values (0% missing data). Moreover, drug type is encoded as a categorical variable (factor) facilitating the joining for analysis.
",
    "It provides data on drug overdose mortality in the US by state from 1999 to 2022. It presents the total number of deaths for each state as well as the rate. This dataset provides crucial information on the impact of this crisis on public health.  Furthermore, the drug overdose dataset is only available for 2022, with 0% missing data.
",
    "It provides data of educational attainment in the US by state from 2012 to 2022. It contains the total population attaining different levels of education for instance the population that have completed high school diploma, bachelor or even graduate degree. These data shed light on whether all students have equal access to educational resources. However, this dataset have 1.73% of missing values which proves that there is a very limited availability of data,  which led us to focus only on the year of 2022.
"
  ),
  KeyVariables = c(
    "Drug Seizures  dataset includes 16 observations and 5 columns on 2022. The first column is the State, a character variable that presents the postal code of the state where the seizure took place (identified with their offices). For each state, we have a  numeric variable which is the quantity lbs of drugs seized, for each type of drugs such as Marijuana, Cocaine, Fentanyl...expressed as a factor variable. Besides, we also have the number of seizure events, considered as a count variable, that shows the total number of seizure incidents for each state.
",
    "Drug Overdose mortality dataset includes 52 observations and 3 variables during the period of 2022.  The first column is the States, a character variable, that includes the state  postal code. Moreover, for each state,  we have numeric variables that reflect the number of Overdoses deaths caused by drugs, as well as the rate of deaths because of drug consumption, per 100 000 habitants.
",
    "Education level dataset includes 53 observations and 8 variables during the year of 2022.  The first column is the States, a character variable, that includes the state  postal code. For each state,  we have numeric variables that express the number of people under 24 who were high school completers, the total number of people of age 25+ who have not completed their secondary education, as well as those who have graduated from high school, those who got a bachelor’s degree and finally those who got a graduate degree.
"
  )
)

# Render the table
knitr::kable(data_description, caption = "Brief data sets description")
```

## Descriptive Analysis

### I. General statsitics

The script processes the `joined_dataset` variable by first renaming key variables to improve clarity: `total_events` becomes `total_seizure_events`, `total_quantity` becomes `total_quantity_seized`, `RATE` becomes `overdose_rate`, and `DEATHS` becomes `overdose_deaths`. We also get rid of the observation "USA" as it is the national aggregate observation.

```{r}
# Rename variables
joined_dataset <- joined_dataset %>%
  rename(
    total_seizure_events = total_events,
    total_quantity_seized = total_quantity,
    overdose_rate = RATE,
    overdose_deaths = DEATHS
  )%>%
  filter(states != "USA")
```

Once the data is filtered, we begin with an exhaustive descriptive analysis that includes all relevant statistical measures, enabling in-depth interpretation.

```{r}
#| message: false
#| cache: false

library(psych)
library(dplyr)
library(knitr)
library(kableExtra)

# Detailed Table of the Descriptive Analysis (we eliminate character variable 'State)
numeric_dataset <- joined_dataset %>%
  select_if(is.numeric)  
summary_table <- describe(numeric_dataset) %>%
    mutate_if(is.numeric, ~ round(., 2))


# Improve the table for the Rendering
kable(summary_table, format = "html", align = "c", caption = "Descriptive Analysis of Variables") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width = TRUE, 
    font_size = 14
  ) %>%
  column_spec(1, bold = TRUE, width = "20em", background = "#f5f5f5") %>%
  row_spec(0, bold = TRUE, background = "#d3d3d3") %>%
  scroll_box(height = "500px")

```

**Discussion**: <br>

-   For the variable **`total_quantity_seized`**, the *mean* is **1049.91**, indicating a relatively high average quantity of drugs seized in the USA. The *standard deviation* of **2455.75** suggests great variability in seizures, showing that some seizures are much larger than the average. The *median*, at **16.01**, is significantly lower than the mean, highlighting an asymmetrical distribution, as evidenced by the *skew* of **1.96**, showing a strong positive asymmetry. This implies that there are several very large seizures pulling the average upwards. *Kurtosis*, at **2.27**, shows a sharp distribution with heavy tails, suggesting that extreme values are frequent.

-   Concerning education, the variable **`years25_atleast_highschool_2022`** has a *mean* of **90020214.71** with a *standard deviation* of **2825202.67**, indicating that the majority of individuals have completed at least high school with moderate variability. The *median* is **90193698.50**, which is close to the mean, and the *skew* of **0.15** indicates an almost symmetrical distribution. For **`years25_bachelor_2022`**, the *mean* is **21452697.71** with a *standard deviation* of **3492597.44**, indicating fewer individuals have attained a bachelor's degree compared to high school. The *median* is **21547985**, which is close to the mean, suggesting a relatively symmetrical distribution. The *kurtosis* of **-0.99** suggests a slightly flatter distribution than normal. For **`years25_graduate_2022`**, the *mean* is **14607153.71**, and the *standard deviation* of **3268291.44** reflects moderate variability. The *skew* of **0.79** highlights a concentration of lower values, indicating that higher-level diplomas are less common.

-   Finally the variable **`overdose_deaths`**, with a *mean* of **3841.29** indicates an average number of fatal overdoses. The *standard deviation* of **2859.11** highlights a high variability in overdose deaths, which is very significant and alarming. The *median* is **2706.00**, notably lower than the mean, indicating a strong positive asymetry, as indicated by the *skew* of **1.04**. This suggests that most values are relatively low, but a few extreme cases of overdose deaths pull the mean upwards. The *kurtosis* of **0.29** suggests a flatter distribution compared to a normal distribution, meaning the extremes are less frequent than initially described. This may call for targeted interventions to treat extreme cases and better understand the factors underlying these deaths.

### II. Median focused

So, let's take a closer look at the statistical measure of the median. To analyze the alignment between education, overdose, and seizure statuses, a composite metric was created for each category (education, overdose, and seizures) by calculating the row-wise mean of relevant variables. States were then classified as "success" or "failure" based on whether their composite score was above or below the national median. Here, the variables are classified as follow: <br><br> <u>Education Variables:</u> classified as "success" if their values are above the national median and "failure" otherwise. <br><br> <u>Overdose Variables:</u> classified as "success" if their values are below the national median and "failure" otherwise. <br><br> <u>Drug Seizure Variables:</u> classified as "success" if their values are below the national median and "failure" otherwise.

*Note that we always filter out the observation USA when calculating descriptive statistics, either by using the function "is.numeric" or "filter" because USA-level data represents an aggregate or national summary, not an individual state, as we are looking forward.*

```{r}
# Create composite scores and classify success/failure
success_status_by_median <- joined_dataset %>%
  mutate(
    # Composite education score and status
    composite_education = rowMeans(select(., years25_bachelor_2022, years25_graduate_2022), na.rm = TRUE),
    education_status = ifelse(composite_education > median(composite_education, na.rm = TRUE), "success", "failure"),
    
    # Composite overdose score and status
    composite_overdose = rowMeans(select(., matches("overdose")), na.rm = TRUE),
    overdose_status = ifelse(composite_overdose < median(composite_overdose, na.rm = TRUE), "success", "failure"),
    
    # Composite seizure score and status
    composite_seizure = rowMeans(select(., starts_with("total")), na.rm = TRUE),
    seizure_status = ifelse(composite_seizure < median(composite_seizure, na.rm = TRUE), "success", "failure")
  )
```

<u>Contingency table:</u> <br>

```{r, message =FALSE, echoes=FALSE, results='hide'}
# Cross-tabulation between education_status, overdose_status, and seizure_status
cross_tab <- table(
  Education = success_status_by_median$education_status,
  Overdose = success_status_by_median$overdose_status,
  Seizure = success_status_by_median$seizure_status
)

print(cross_tab)
```

```{r}
# Create a data frame for the table
contingency_data <- data.frame(
  Seizure_Status = c("Failure", "Failure", "Failure", "Failure", 
                     "Success", "Success", "Success", "Success"),
  Overdose_Status = c("Failure", "Failure", "Success", "Success",
                      "Failure", "Failure", "Success", "Success"),
  Education_Status = c("Failure", "Success", "Failure", "Success", 
                       "Failure", "Success", "Failure", "Success"),
  Count = c(2, 2, 2, 1, 
            2, 1, 1, 3)
)
# Create the table using kable
kable(contingency_data, format = "html", align = "c", caption = "Contingency Table for Seizure, Overdose, and Education Status") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE, font_size = 14)
```

**Performance comparison accross variables:** The main conclusions from this contingency table are that, firstly, states with better education metrics (success) are more likely to have lower overdose rates (success), especially when drug seizures fail. Education appears to be a strong protective factor against overdoses. Secondly, success in drug seizures does not consistently lead to lower overdose rates, highlighting that seizures alone are insufficient to address overdoses comprehensively.

### III. Mean focused

<br> This step of the descriptive analysis focuses on categorizing states into "success" and "failure" groups based on their performance relative to the **mean** for three key metrics: education, overdose rates, and drug seizures. Education variables are labeled as "success" if they exceed the mean, while overdose and drug seizure variables are labeled as "success" if they fall below the mean. <br>

```{r}
# Exclude USA observation and apply transformations
success_status_by_mean <- joined_dataset %>%
  mutate(
    # Education variables: "success" if > mean, otherwise "failure"
    across(contains("2022"), ~ ifelse(. > mean(., na.rm = TRUE), "success", "failure")),

    # Overdose variables: "success" if < mean, otherwise "failure"
    across(matches("overdose_rate|overdose_deaths"), ~ ifelse(. < mean(., na.rm = TRUE), "success", "failure")),

    # Drug seizure variables: "success" if < mean, otherwise "failure"
    across(starts_with("total"), ~ ifelse(. < mean(., na.rm = TRUE), "success", "failure"))
  )

kable(
  head(success_status_by_median, 3), 
  caption = " Classification of Success and Failure Based on Mean for Education, Overdoses, and Drug Seizures Variables", 
  escape = FALSE
)
```

The counts of "success" and "failure" are then summarized for each category.

```{r}
# Summarising success and failure counts
summary_success_status_by_mean <- success_status_by_mean %>%
  summarise(
    education_success = sum(across(contains("2022"), ~ . == "success"), na.rm = TRUE),
    education_failure = sum(across(contains("2022"), ~ . == "failure"), na.rm = TRUE),
    overdose_success = sum(across(matches("overdose_rate|overdose_deaths"), ~ . == "success"), na.rm = TRUE),
    overdose_failure = sum(across(matches("overdose_rate|overdose_deaths"), ~ . == "failure"), na.rm = TRUE),
    drug_seizure_success = sum(across(starts_with("total"), ~ . == "success"), na.rm = TRUE),
    drug_seizure_failure = sum(across(starts_with("total"), ~ . == "failure"), na.rm = TRUE)
  )
```

Finally, a proportional bar chart is created to visually represent the distribution of "success" and "failure" across the three metrics, using distinct colors for each status. This visualization highlights the relative performance of states within each category.

```{r}
# Prepare data for plotting directly from summary_success_status
plot_data <- data.frame(
  Category = c("Education", "Education", "Overdose", "Overdose", "Drug Seizure", "Drug Seizure"),
  Status = c("Success", "Failure", "Success", "Failure", "Success", "Failure"),
  Count = c(
    summary_success_status_by_mean$education_success,
    summary_success_status_by_mean$education_failure,
    summary_success_status_by_mean$overdose_success,
    summary_success_status_by_mean$overdose_failure,
    summary_success_status_by_mean$drug_seizure_success,
    summary_success_status_by_mean$drug_seizure_failure
  )
)

# Create the bar chart
ggplot(plot_data, aes(x = Category, y = Count, fill = Status)) +
  geom_bar(stat = "identity", position = "fill", width = 0.6) + # position = "fill" makes the bars proportional
  scale_fill_manual(values = c("Success" = "steelblue", "Failure" = "tomato")) + # Custom colors
  labs(
    title = "Proportion of Success and Failure by Category",
    x = "Category",
    y = "Proportion",
    fill = "Status"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format()) # Show proportions as percentages
```

-   **Comments:**

    The high proportion of "success" in the Drug Seizure category suggests that most states have relatively low drug seizure quantities and events compared to the mean. This could indicate effective enforcement or that fentanyl distribution is not uniform across states. However, the correlation between drug seizures and overdoses needs further exploration—states with fewer seizures might still have high overdose rates due to the potency and availability of fentanyl.<br> <br> The Education category shows an almost equal distribution of "success" and "failure." This highlights significant variability in education levels across states, with some performing above the mean and others falling behind. For the research question, this variation in education levels could be crucial for understanding differences in overdose rates. States with higher education success may have populations better equipped to avoid risky behaviors or access preventive measures, potentially correlating with lower overdose rates.<br> <br> The Overdose category shows a higher proportion of "failure," indicating that many states have overdose rates or deaths exceeding the mean. This finding emphasizes that fentanyl overdoses remain a widespread problem, disproportionately affecting certain states. It suggests that efforts to mitigate overdoses need to focus on a majority of states where fentanyl use has escalated. <br> <br> The variability observed across education and overdose categories suggests a potential relationship between the two. States with high education failure (e.g., lower levels of high school or college attainment) might correspond to those with higher overdose failure, reflecting possible socioeconomic and educational disparities contributing to the fentanyl crisis. Conversely, states with education success might demonstrate better public health outcomes, including lower overdose rates. We will developp this later.

### IV. Relationships' Graphs

A- <u>Overdoses and Seizures</u> <br><br> Examining the relationship between the quantity of fentanyl seized and the number of overdose deaths is critical because seizures are being used as a proxy (= an indicator) for drug consumption. By analyzing this relationship, we can explore whether higher quantities of fentanyl seized (and thus higher inferred consumption) are associated with increased overdose deaths. This analysis helps to validate the use of seizure data as an indicator of consumption trends.<br> <br>

The first step was to fit a linear regression model to assess the relationship between the total quantity of fentanyl seized (total_quantity_seized) and the number of overdose deaths (overdose_deaths) using the joined_dataset. We have to perform this step because the regression line is not appearing by itself using the "geom_point" only due to the interactive nature of the graph. The regression model predicts overdose deaths based on the quantity seized. In our interactive scatterplot, data points represent individual states.

```{r, warning= FALSE}
# Fit the regression model
model <- lm(overdose_deaths ~ total_quantity_seized, data = joined_dataset)

# Predict values for the regression line
regression_line_1 <- data.frame(
  total_quantity_seized = seq(min(joined_dataset$total_quantity_seized, na.rm = TRUE),
                              max(joined_dataset$total_quantity_seized, na.rm = TRUE),
                              length.out = 100)
)
regression_line_1$overdose_deaths <- predict(model, newdata = regression_line_1)

# Create the ggplot with manual regression line
interactive_plot_1 <- ggplot() +
  geom_point(data = joined_dataset, aes(x = total_quantity_seized, 
                                        y = overdose_deaths, 
                                        text = paste("State: ", states,  "<br>Quantity seized: ", total_quantity_seized, 
                                                     "<br>Overdose Deaths: ", overdose_deaths)), 
             color = "blue") +
  geom_line(data = regression_line_1, aes(x = total_quantity_seized, y = overdose_deaths), 
            color = "red") +
  labs(
    title = "Relationship Between Total Quantity Seized and Quantity of Overdose",
    x = "Total Quantity of Fentanyl Seized",
    y = "Number of Overdose Deaths (per 100,000)"
  )

# Convert to interactive plotly plot
plotly_plot_1 <- ggplotly(interactive_plot_1, tooltip = "text")

plotly_plot_1
```

-   **Comments:**

    The graph shows a positive relationship between the total quantity of fentanyl seized and the number of overdose deaths per 100,000 people. This suggests that states with higher quantities of fentanyl seized tend to have higher overdose death rates. This implies that using drug seizure as a proxy of drug consumption is valid. <br><br> To test the degree to which this conclusion is true, we perform a summary of the linear model between the total number of overdose deaths and the total quantity seized of fentanyl:

    ```{r}
    library(broom)
    ```

```{r, message =FALSE, echoes=FALSE}
# Fit the linear model
model <- lm(overdose_deaths ~ total_quantity_seized, data = joined_dataset)

# Extract regression summary into a tidy format
regression_summary <- tidy(model)
model_stats <- glance(model)

# Create a summary table for the regression
summary_table <- data.frame(
  Metric = c("Intercept", "Slope (total_quantity_seized)", "R-squared", "Adjusted R-squared", "Residual Std. Error", "F-statistic", "p-value"),
  Value = c(
    regression_summary$estimate[1], 
    regression_summary$estimate[2], 
    model_stats$r.squared, 
    model_stats$adj.r.squared, 
    model_stats$sigma, 
    model_stats$statistic, 
    model_stats$p.value
  )
)

# Create a formatted table
kable(summary_table, format = "html", align = "c", caption = "Regression Summary Table") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE, font_size = 14)
```

The regression analysis reveals a **statistically significant** positive relationship between the quantity of fentanyl seized and overdose deaths. The coefficient for fentanyl seizures is 0.6547 (p = 0.03635), indicating that for every unit increase in fentanyl seized, the overdose death rate increases by 0.6547 per 100,000 people. The model explains 31.6% of the variance in overdose deaths (R-squared = 0.3162), highlighting a moderate relationship, though a significant amount of variation remains unexplained. While the model is statistically significant overall (F-statistic p = 0.03635), the residual standard error of 2461 indicates considerable variability in the data. **These findings suggest that higher fentanyl seizures may reflect greater fentanyl circulation, contributing to more overdose deaths.** <br> <br> B- <u>Education and Overdoses</u> <br><br> Here is a table of all the graphical representations we tested to assess relationships between those two variables (education and overdoses) and that we decided not to keep as they were not conclusive, we also provide an explanation and the reasons why they were not usable as a proof in our analysis:

```{r}
# Create the data for the table
data <- data.frame(
  Relationship = c(
    "Between Graduate's Degree Number and Overdose Rates",
    "Between Graduate's Degree Number and Overdose Quantity",
    "Between Bachelor's Degree Number and Overdose Rates"
  ),
  Variables = c(
    "x = `years25_graduate_2022`, y = `overdose_rate`",
    "x = `years25_graduate_2022`, y = `overdose_deaths`",
    "x = `years25_bachelor_2022`, y = `overdose_rate`"
  ),
  Reason = c(
    "It does not show a clear connection between the two variables. The relationship (regression line) is mostly flat, with no strong trend, and does not support our goal of showing how education might help reduce overdose rates. We tested the R-squared in an in-depth analysis and the latest was extremely low: 0.002, confirming the impossibility to draw conclusions from this graph.",
    "The x variable has not changed compared to the previous relationship analyzed, but the y variable is now the number of overdose deaths instead of the lethal overdose rate. The regression line was similar to the previous one, showing no clear relationship and with a very low R-squared of 0.002.",
    "The regression line showed a slightly positive relationship between the two variables, that is, the higher the number of bachelor's degrees, the higher the lethal overdose rate, which contradicts our hypothesis. However, this positive relationship was not statistically significant (R-squared = 0.01)."
  )
)

# Render the table
knitr::kable(data, caption = "Analysis Summary of Relationships")
```

```{r, warning= FALSE}
# Fit the regression model
model <- lm(overdose_deaths ~ years25_bachelor_2022, data = joined_dataset)

# Predict values for the regression line
regression_line_2 <- data.frame(
  years25_bachelor_2022 = seq(min(joined_dataset$years25_bachelor_2022, na.rm = TRUE),
                              max(joined_dataset$years25_bachelor_2022, na.rm = TRUE),
                              length.out = 100)
)
regression_line_2$overdose_deaths <- predict(model, newdata = regression_line_2)

# Create the ggplot with manual regression line
interactive_plot_2 <- ggplot() +
  geom_point(data = joined_dataset, aes(x = years25_bachelor_2022, 
                                        y = overdose_deaths, 
                                        text = paste("State: ", states, 
                                                     "<br>Bachelor's Degrees: ", years25_bachelor_2022, 
                                                     "<br>Overdose Deaths: ", overdose_deaths)), 
             color = "blue") +
  geom_line(data = regression_line_2, aes(x = years25_bachelor_2022, y = overdose_deaths), 
            color = "red") +
  labs(
    title = "Relationship Between Bachelor's Degree Number and Quantity of Overdose",
    x = "Number of Bachelor's Degree",
    y = "Number of Overdose Deaths (per 100,000)"
  )

# Convert to interactive plotly plot
plotly_plot_2 <- ggplotly(interactive_plot_2, tooltip = "text")

# Display the interactive plot
plotly_plot_2
```

-   **Comments:**

    The red trendline shows a clear negative slope, indicating an inverse relationship between the number of bachelor's degrees and overdose deaths. States with higher numbers of bachelor's degrees tend to have fewer overdose deaths, suggesting that higher education levels may correlate with better health outcomes or reduced drug-related mortality. <br> The goal here is to check if this negative relationship is statistically significant, using the summary of the linear model.

```{r, message = FALSE}
# Fit the linear model
model <- lm(overdose_deaths ~ years25_bachelor_2022, data = joined_dataset)

# Extract regression summary into a tidy format
regression_summary <- tidy(model)
model_stats <- glance(model)

# Create a summary table for the regression
summary_table <- data.frame(
  Metric = c("Intercept", "Slope (years25_bachelor_2022)", "R-squared", "Adjusted R-squared", "Residual Std. Error", "F-statistic", "p-value"),
  Value = c(
    regression_summary$estimate[1], 
    regression_summary$estimate[2], 
    model_stats$r.squared, 
    model_stats$adj.r.squared, 
    model_stats$sigma, 
    model_stats$statistic, 
    model_stats$p.value
  )
)

# Create a formatted table
kable(summary_table, format = "html", align = "c", caption = "Regression Summary Table: Relationship Between Bachelor's Degree Number and Overdose Deaths") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE, font_size = 14)
```

The regression analysis indicates a **weak negative relationship** between **the number of bachelor’s degrees and overdose deaths**, as shown by the coefficient of -0.0001758, suggesting that for every increase of 10,000 bachelor’s degrees, the overdose death rate decreases by 1.758 per 100,000 people. However, this relationship is not statistically significant at the 0.05 threshold, with a p-value of 0.098. The model explains only about 21% of the variance in overdose deaths (R-squared = 0.2104), highlighting its limited explanatory power. Additionally, the residual standard error of 2644 suggests substantial variability in the data. These results indicate that additional factors beyond education levels, such as economic or healthcare-related variables, likely play a significant role in influencing overdose deaths, and their inclusion may improve the model's effectiveness. <br> <br>

*An example of a graphical representation showing absurd conclusions for our analysis:*

```{r, warning= FALSE}
joined_dataset_modified <- joined_dataset 

colnames(joined_dataset_modified)[colnames(joined_dataset_modified) == "years25_total_bachelor+_2022"] <- "years25_bachelorormore_2022"

# Fit the regression model
model <- lm(overdose_deaths ~ years25_bachelorormore_2022, data = joined_dataset_modified)

# Predict values for the regression line
regression_line_3 <- data.frame(
  years25_bachelorormore_2022 = seq(min(joined_dataset_modified$years25_bachelorormore_2022, na.rm = TRUE),
                              max(joined_dataset_modified$years25_bachelorormore_2022, na.rm = TRUE),
                              length.out = 100)
)
regression_line_3$overdose_deaths <- predict(model, newdata = regression_line_3)

# Create the ggplot with manual regression line
interactive_plot_3 <- ggplot() +
  geom_point(data = joined_dataset_modified, aes(x = years25_bachelorormore_2022, 
                                        y = overdose_deaths, 
                                        text = paste("State: ", states, 
                                                     "<br>Bachelor's Degrees or more: ", years25_bachelorormore_2022, 
                                                     "<br>Overdose Deaths: ", overdose_deaths)), 
             color = "blue") +
  geom_line(data = regression_line_3, aes(x = years25_bachelorormore_2022, y = overdose_deaths), 
            color = "red") +
  labs(
    title = "Relationship Between the Number of Bachelor's Degree or more and Quantity of Overdose",
    x = "Number of people who have a Bachelor's Degree or more",
    y = "Number of Overdose Deaths (per 100,000)"
  )

# Convert to interactive plotly plot
plotly_plot_3 <- ggplotly(interactive_plot_3, tooltip = "text")

# Display the interactive plot
plotly_plot_3
```

-   **Comments:**

    This graphical representation is particularly interesting to keep in our analysis for several reasons. First, it reveals a **positive relationship** between **the number of people who have completed at least a bachelor's degree and the quantity of overdose deaths**. In other words, the graph suggests that higher levels of education, contrary to expectations, are associated with higher numbers of overdose deaths. This contradicts our hypothesis, which is that education should help reduce such outcomes. Keeping this graph allows us to highlight and discuss unexpected findings, potentially pointing to other factors that may confound the relationship between education and overdose outcomes. Additionally, it shows the importance of a multidimensional approach to understanding these variables. Making some research allows us to find potential reasons for this result. The three main ones are the following: <br><br> 1- Regions with higher levels of education may also have higher income levels, which could increase access to opioids and other drugs, leading to higher rates of overdose deaths.<br> <br> 2- While better education may improve healthcare access, it could also inadvertently increase access to prescription opioids, which are a significant driver of overdose deaths. <br><br> 3- The positive relationship might be influenced by outliers or specific states where the dynamics between education and overdose deaths differ significantly from the national trend. Here, California, Florida are pushing the regression line up. <br> <br>

*We got the same results when using the variable `overdose_rate` instead of `overdose_deaths`.*

<br><br> C- <u>Seizure and Education</u> <br> <br> Here again, we provide a table giving the different graphical representations that we tested but did not keep for our analysis:

```{r}
data <- data.frame(
  Relationship = c(
    "Between Graduate's Degree Number and the Quantity Seized",
    "Between Number of Bachelor's Degree or more and Quantity of Overdose"
  ),
  Variables = c(
    "x = `years25_graduate_2022`, y = `total_quantity_seized`",
    "x = `years25_total_bachelor+_2022`, y = `total_quantity_seized`"
  ),
  Reason = c(
    "The regression line was diplaying a negative relationship but with a very flat shape. We tested the R-squared in an in-depth analysis and the latest was extremely low: 0.01694, confirming the impossibility to draw conclusions from this graph.",
    "The y variable has not changed compared to the previous relationship analyzed, but the x variable is now the number of people who got a bachelor's degree or more. This time, the regression line was showing a weak positive relationship between the variables, this trend was due to two major outliers: Alaska and California, that have a high total quantity of fentanyl seized. However, again the R-squared was extremely low: 0.00262."
  )
)

# Render the table
knitr::kable(data, caption = "Analysis Summary of Relationships")
```

```{r, warning= FALSE}
# Fit the regression model
model <- lm(total_quantity_seized ~ years25_bachelor_2022, data = joined_dataset)

# Predict values for the regression line
regression_line_4 <- data.frame(
  years25_bachelor_2022 = seq(min(joined_dataset$years25_bachelor_2022, na.rm = TRUE),
                              max(joined_dataset$years25_bachelor_2022, na.rm = TRUE),
                              length.out = 100)
)
regression_line_4$total_quantity_seized <- predict(model, newdata = regression_line_4)

# Create the ggplot with manual regression line
interactive_plot_4 <- ggplot() +
  geom_point(data = joined_dataset, aes(x = years25_bachelor_2022, 
                                        y = total_quantity_seized, 
                                        text = paste("State: ", states, 
                                                     "<br>Bachelor's Degrees or more: ", years25_bachelor_2022, 
                                                     "<br>Overdose Deaths: ", total_quantity_seized)), 
             color = "blue") +
  geom_line(data = regression_line_4, aes(x = years25_bachelor_2022, y = total_quantity_seized), 
            color = "red") +
  labs(
    title = "Relationship Between Bachelor's Degree Number and the Quantity Seized",
    x = "Number of bechelor's Degree",
    y = "Total quantity of fentanyl seized"
  )

# Convert to interactive plotly plot
plotly_plot_4 <- ggplotly(interactive_plot_4, tooltip = "text")

# Display the interactive plot
plotly_plot_4
```

```{r}
library(broom)
# Fit the linear model
model <- lm(total_quantity_seized ~ years25_bachelor_2022, data = joined_dataset)

# Extract regression summary into a tidy format
regression_summary <- tidy(model)
model_stats <- glance(model)

# Create a summary table for the regression
summary_table <- data.frame(
  Metric = c(
    "Intercept", 
    "Slope (years25_bachelor_2022)", 
    "R-squared", 
    "Adjusted R-squared", 
    "Residual Std. Error", 
    "F-statistic", 
    "p-value"
  ),
  Value = c(
    regression_summary$estimate[1],  # Intercept
    regression_summary$estimate[2],  # Slope
    model_stats$r.squared,           # R-squared
    model_stats$adj.r.squared,       # Adjusted R-squared
    model_stats$sigma,               # Residual Std. Error
    model_stats$statistic,           # F-statistic
    model_stats$p.value              # p-value
  )
)

# Create a formatted table
kable(
  summary_table, 
  format = "html", 
  align = "c", 
  caption = "Regression Summary Table: Relationship Between Bachelor's Degree Number and Total Quantity Seized"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE, 
    font_size = 14
  )
```

-   **Comments:**

    The graph illustrates a **negative relationship** between **the number of bachelor's degrees** and the total quantity of fentanyl seized. This trend is further supported by the regression analysis results, where the coefficient for `years25_bachelor_2022` is -0.0001725, indicating that for every additional 10,000 bachelor's degrees, the total fentanyl quantity seized decreases by approximately 1.725 units. However, while the relationship is statistically significant at the 0.1 level (p-value = 0.0544), it is not at the 0.05 threshold, limiting the confidence in this result. Additionally, the R-squared value of 0.2747 suggests that approximately 27.47% of the variance in fentanyl seizures is explained by the number of bachelor's degrees, highlighting some explanatory power but also leaving room for other contributing factors.

*Note that we don't perfom the same graph using the total number of seizure events as it doesn't give information on the consumption of fentanyl. In fact, a state X could have a much lower total number of seizure events than state Y and still have a higher quantity seized than state Y.*

### V. Regional Trends

The goal of this section is to conduct a cross-regional analysis as part of our descriptive analysis. Early in our research, we noticed that drug seizure data was available for only a few states, primarily those located along the U.S. borders. This observation hints at potential trafficking patterns, such as border states (e.g., Texas, California, Arizona) serving as primary entry points for drugs illegally transported into the country.

This analysis aims to identify regions with the highest overdose rates, education levels, and drug seizure quantities, and to investigate possible reasons behind these patterns. For instance, we anticipate the southern region might exhibit higher drug consumption and overdose rates due to its proximity to South America, particularly Mexico, where fentanyl distribution increased significantly in 2022, the year of our analysis. Similarly, the eastern region may show elevated education metrics, given the presence of many top universities. Lastly, we will test our broader hypothesis: whether regions with lower education levels are disproportionately impacted by the opioid crisis across the four defined regions.

A- <u>Define regions clearly</u> <br><br> I will first replicate the joined_data set but replacing the variable `states` by a variable `region` that will contain four observations: **north**, **south**, **west**, **midwest**.

```{r}
joined_dataset_region <- joined_dataset %>%
  mutate(region = case_when(
    states %in% c("WA", "CA", "AZ", "MT") ~ "West",
    states %in% c("ME", "NY", "MA") ~ "North",
    states %in% c("TX", "LA", "FL", "GA", "MD") ~ "South",
    states %in% c("MI", "IL") ~ "Midwest"
  ))
joined_dataset_region <- joined_dataset_region %>%
  select(states, region, everything())

joined_dataset_region <- joined_dataset_region %>%
  group_by(region) %>%
  summarise(
    total_seizure_events = sum(total_seizure_events, na.rm = TRUE),
    total_quantity_seized = sum(total_quantity_seized, na.rm = TRUE),
    total_events_proportion = mean(total_events_proportion, na.rm = TRUE),
    total_quantity_proportion = mean(total_quantity_proportion, na.rm = TRUE)
  )
```

(to be continued)

## Predictive Analysis

### I. Regression model and estimations:

Since our reaserch question is causal, we'll need to characterize and predict the links between our variables. We'll investigate those potential links through the estimation of our regression model. In order to construct our model,

-   [**Dependent variable (Y) :**]{.underline}

**- Overdose_Deaths:** metric that quantifies the number of fatal overdoses

-   [**Independent variables (X):**]{.underline}

**- X1 = Years25_LessHighSchool_2022 :**This variable is expected to have a positive relationship with overdose deaths, as lower education levels may correlate with higher risks of substance misuse and limited access to preventive measures.

**- X2 = Years25_Bachelor_2022 :** Its supposed to have a negative relationship with overdose deaths, since higher education levels may correlate with better socioeconomic status and health outcomes.

**- X3 = Years25_Graduate_2022 :**This variable is also expected to have a negative relationship with overdose deaths, reflecting the potential protective effects of higher education.

**- X4 = Total_Quantity_Seized :**It’s supposed to have positive relationship with overdose deaths, since high quantity seized means that  there is a high consumption of drugs, which yields to higher deathsq

Hence, we get a *multiple linear regression model* such as:

```{r, echo=FALSE, results='hide'}
# Linear regression model
library(broom)
regression_model <- lm(overdose_deaths ~ less24years_highschool_2022 + 
                             years25_LessHighSchool_2022 + 
                             years25_onlyhighschool_2022 +
                             years25_bachelor_2022 + 
                             years25_graduate_2022 + 
                             total_seizure_events + 
                             total_quantity_seized,  
                data = joined_dataset)

tidy(regression_model) 
```

**Overdose_Deaths i**  = β0 + β1\*​(less24years_highschool_2022​) + β2​\*(years25_LessHighSchool_2022​) +  +β3 \* ​(years25_onlyhighschool_2022​) + β4\*​(years25_bachelor_2022​)+ β5\*​(years25_graduate_2022​)+ β6\*​(total_seizure_events​) + β7\*​(total_quantity_seized​) +ϵi​

Where:

-   **β0** : Intercept.

-   **𝛽1,𝛽2,𝛽3, 𝛽4**: Coefficients associated with explanatory variables.

-   **𝜀𝑖:** Random error term, assumed to follow a normal distribution 𝑁(0,𝜎2)

**Test Hypothesis**

-   [Null hypothesis (𝐻0) :]{.underline}

    -   **𝐻0 :**  **𝛽𝑖 = 0**

    -   There is no statistically significant relationship between the independent variable 𝑋𝑖 and the number of overdose deaths. This means that 𝑋𝑖 does not explain variations in overdose deaths.

-   [Alternative hypothesis (𝐻1):]{.underline}

    -   **𝐻1 :**    **𝛽𝑖 ≠ 0**

    -   There is a statistically significant relationship between the independent variable 𝑋𝑖 and the number of overdose deaths. In other words, 𝑋𝑖 helps explain variations in overdose deaths

**Our Assumptions:**

The multiple linear regression model take into consideration some assumptions:

1.  The relationship between the independent variables (education levels) and the dependent variable (overdose deaths) is [*linear*]{.underline}.

2.  Observations (states) are [*independent*]{.underline}, it corresponds to the index i.

3.  The variance of the residuals is [*constant*]{.underline} across all of the independent variables.

4.  The residuals of the model are [*normally distributed*]{.underline}.

5.  The independent variables (specially education levels) are n[*ot highly*]{.underline}

    [*correlated*]{.underline} with each other. We proceed to the verification using the Variance 

    Inflation Factor (VIF).

**Estimation of the multiple linear regression linear:**

We will use the ordinary least squares (OLS) method to estimate the model coefficients.

```{r}
library(knitr)
library(kableExtra)
# Extract the model
summary_table <- summary(regression_model)$coefficients
colnames(summary_table) <- c("Estimate", "Std. Error", "t-value", "Pr(>|t|)")

# We convert the table into HTML format using kableExtra
kable(summary_table, format = "html", align = "c", caption = "Results of the linear regression") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F, font_size = 14) %>%
  column_spec(1, bold = T, color = "black", background = "#f7f7f7") %>%
  row_spec(0, bold = T, background = "#D3D3D3") 
```

-   **i) Statistical Significance Analysis of Coefficients**

    First, let’s analyze the statistical significance of the estimated coefficients\

    \- The **intercept** coefficient estimates **β0 = 7982.457** reflects a positive value, suggesting that when all independent variables are zero,  the number  of overdose deaths would be 7982. However, since p=0.558, this indicates that the intercept is not significant,  which make sense since it  is unlikely that variables  like education would be zero all simultaneously in the real world

    \- The variable **less24years_highschool_2022** has a coefficient of **β1 = 0.000177,** and a p-value **0.558507**. This explains that an additional person having completed high school implies an increase of 0.000177 in the number of overdose deaths.The effect of this variable on overdose deaths appears to be very small and statistically insignificant. Therefore, for this model, the proportion of young people under 24 without a high school diploma is not a major explanatory factor.

    \- The coefficient of the variable **years25_LessHighSchool_2022** is **β2 = 0.0007049** with a p-value of **0.08** (close to significance at the 0.05 level). Indeed, the variable has a moderate positive effect on overdose deaths. Although not strictly significant, it indicates that high proportions of people aged 25 and over without a high school diploma are associated with an increase in overdose deaths.

    \- The variable **years25_onlyhighschool_2022** has an estimate of **β3= -0.0003639** and a **p-value** of **0.33** (not significant). Hence, this variable shows a non-significant negative effect. This suggests that a higher proportion of young people with only a high school diploma (and nothing beyond) is associated with a slight reduction in overdose deaths, but this result is not conclusive.

    \- The estimate of **years25_bachelor_2022** is **β4** **= -0.0000808** with a **p-value : 0.49** (not significant). The proportions of people with a university degree (bachelor) also appear to have a non-significant negative effect on overdose deaths.This may be explained by the fact that higher education offers greater protection against overdose deaths, but the result remains weak.

    \- The variable **years25_graduate_2022** has an estimate of **β5 = -0.0000497** and a p-value of **0.88** (not significant). The proportions of graduates have no significant effect on overdose deaths in this model.

    \- The estimate of the variable **total_seizure_events** is **β6 = -7.6052413** with p-value of **0.71** (not significant). Thus, the total number of seizure events appears to have a (small) negative effect on overdose deaths, but this result is not statistically significant. This means that efforts to seize substances have a limited impact on reducing deaths.

    \- The variable **total_quantity_seized** has an estimate **β7 = 0.3498855** and a p-value of **0.80** (not significant). Thus, the total quantity of substances seized has a non-significant positive effect on overdose deaths.This reflects the fact that regions where more drugs are seized are also those where access to substances is higher with high overdose deaths, but this relationship remains non-significant.

-   **ii) Interpretation of the main results:**

    None of the model variables is statistically significant at the 0.05 level, although **years25_LessHighSchool_2022** approaches marginal significance.This could be due to small sample size or collinearity between explanatory variables.\

    Moreover, variables associated with higher levels of education (bachelor, graduate) have negative coefficients, which is consistent with the idea that education may play a protective role. It suggests that individuals with greater educational attainment tend to be more aware of the risk of fentanyl and drugs consumption. On the other hand, higher. educated people have better access to health care, and improved health literacy\

    Variables associated with lower levels of education (less than high school) tend to have positive coefficients, implying a potential association with higher overdose rates.

### II. Model fit analysis

1.  **Verification of our assumptions**

It is essential to start by checking that the model respects the assumptions of multiple linear regression.

-   [**a. Linearity**]{.underline}:

In order to check the linearity, we will plot residuals against predicted values:

```{r}
# we calculate the residual values
residuals <- resid(regression_model)

# Predicted values
fitted_values <- fitted(regression_model)

# graphics with residuals
plot(fitted_values, residuals,
     xlab = "Values predicted",
     ylab = "Residuals",
     main = "Graphics of the residuals with errors",
     pch = 19, col = "blue")

# we add an horizontal line y = 0
abline(h = 0, col = "red", lwd = 2)

# we add a curve in order to represent an estimation of errors. 
lines(lowess(fitted_values, residuals), col = "green", lwd = 2)

# Legend
legend("topright", legend=c("Residuals", "Error estimated"), col=c("blue", "green"), pch=c(19, NA), lty=c(NA, 1))
```

-   **Comments:**

    The green line shows a slightly non-linear trend (curved shape). This may indicate that the relationship between our independent variables and the overdoses deaths is [not strictly linear]{.underline}. (we might consider adding quadratic terms or transforming certain variables to capture this non-linearity)

    Moreover, residuals appear to vary unequally around the red line. For instance, residuals on the left (low predicted values) and right (high predicted values) appear to be more dispersed. This could indicate [heteroscedasticity]{.underline}. (we will test it later )

Now we should correct the violation of the first assumption, one alternative is to use the spline since using quadratic form or even adding log in our model do not solve the linearity problem. Spline is very powerful and useful specially when we have complex relation between variables

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(splines)

# Use the splines
spline_model <- lm(overdose_deaths ~ bs(years25_LessHighSchool_2022, df = 3) +
                   bs(years25_onlyhighschool_2022, df = 3) + 
                   bs(years25_bachelor_2022, df = 3) + 
                   bs(years25_graduate_2022, df = 3) + 
                   bs(total_seizure_events, df = 3) + 
                   bs(total_quantity_seized, df = 3), 
                   data = joined_dataset)
summary(spline_model)

# Verify the residuals
residuals <- resid(spline_model)
fitted_values <- fitted(spline_model)

plot(fitted_values, residuals,
     xlab = "Values predicted",
     ylab = "Residuals",
     main = "Graphic of residuals(Splines)",
     pch = 19, col = "blue")
abline(h = 0, col = "red", lwd = 2)
lines(lowess(fitted_values, residuals), col = "green", lwd = 2)
```

[**b. Independence:**]{.underline}

We should make sure that the residuals are not correlated in our model, thus, we use the Durbin-Watson test

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(lmtest)

# Test of Durbin-Watson
dw_test <- dwtest(regression_model)
# The final result
cat("Durbin-Watson Test Result is DW =", round(dw_test$statistic, 4),"and p-value =", round(dw_test$p.value, 4),"\n" )
cat("Thus, Residuals are not significantly autocorrelated.\n")
```

-   **Comments:**

    The Durbin-Watson test produced a DW statistic of **2.0858** with a p-value of **0.4365**. This indicates that we do not reject the null hypothesis of no autocorrelation of the residuals, as the p-value is well above the usual level of 0.05. In other words, there is no significant evidence of positive autocorrelation in the residuals of the regression model, suggesting that the observations are independent of each other.

    [**c. Homoscedasticity**]{.underline}

Now, let' s verify whether the variance of the residuals is constant. Therefore, we test homoscedasticity using the Breusch-Pagan test

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Test of Breusch Pagan
bp_test_result <- bptest(regression_model)
# The final result
cat("The studentized Breusch-Pagan test result is BP =", round(bp_test_result$statistic, 4),"and p-value =", round(bp_test_result$p.value, 4),"\n" )

```

-   **Comments:**

    The Breusch-Pagan test shows a BP statistic of 4.9716 with 7 degrees of freedom and a p-value of 0.6634. It means that we do not reject the null hypothesis of homoscedasticity, since the p-value is above the usual 0.05 level. Thus, there is no significant evidence of heteroscedasticity in the residuals of the regression model, implying that the variance of the residuals is constant across the predicted values and that the model homoscedasticity assumption is respected.

    [**d. Normality of distribution**]{.underline}

In order to verify if the sample follows a normal distribution, we use the Shapiro-Wilk test. The test's null hypothesis is that the data are normally distributed (and the alternative hypothesis is the inverse).

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# We calculate the residuals
residuals <- resid(regression_model)

# the Shapiro-Wilk test
shapiro_test_result <- shapiro.test(residuals)
cat("Shapiro-Wilk normality test is W =", round(shapiro_test_result$statistic, 4),"and p-value =", round(shapiro_test_result$p.value, 4),"\n" )

```

-   **Comments:**

    The Shapiro-Wilk test present a result of **0.90816** with a p-value of **0.1482**. This means that we do not reject the null hypothesis that the residuals follow a normal distribution, as the p-value is above the usual 0.05 level. After all, there is insufficient evidence to conclude that the residuals of the regression model are not normally distributed, suggesting that this hypothesis is met in our analysis.

We can also draw QQ plot

```{r}
#Graphic Q-Q
qqnorm(residuals)
qqline(residuals, col = "red")  # we add a red line as a reference  
```

or we can also visualize it this way:

```{r}
# we extract residuals in our model  
residuals <- resid(regression_model)

# we normalize residuals into. stardardized residuals
std_residuals <- scale(residuals)

# Density of standardized residuals
plot(density(std_residuals), 
     main = "Density of Normalized Residuals", 
     xlab = "Standardized Residuals (X)", 
     ylab = "Density", 
     col = "black", 
     lwd = 2)

# adding vertical lines forconfidence interval  (95%)
abline(v = c(-1.96, 1.96), col = "black", lty = "dashed")

# adding shadow areas in the tails distribution
x <- seq(-4, 4, by = 0.001)
y <- dnorm(x)

# Area left of -1.96
polygon(c(x[x <= -1.96], -1.96), c(y[x <= -1.96], 0), col = "gray", border = NA)

#Area right of -1.96
polygon(c(x[x >= 1.96], 1.96), c(y[x >= 1.96], 0), col = "gray", border = NA)

# adding legends
legend("topright", 
       legend = c("Density of residuals", "Interval of confidence (95%)"), 
       col = c("black", "black"), 
       lty = c(1, 2), 
       lwd = c(2, 1))

```

2.  **Statistic Tests**:

Now that we have checked that the hypotheses have been met, we proceed with the statistical tests to assess the relationships between the variables.

-   [**Chi-squared test χ2.**]{.underline}

    Since we have numerical variables, we should categorize them in order to use theChi test. Therefore, we will tranforme them using quartiles

```{r}
# Categorization of years25_LessHighSchool_2022
joined_dataset$less_highschool_category <- cut(joined_dataset$years25_LessHighSchool_2022, 
                                               breaks = quantile(joined_dataset$years25_LessHighSchool_2022, probs = seq(0, 1, 0.25), na.rm = TRUE), 
                                               labels = c("Low", "Medium", "High", "Very High"), 
                                               include.lowest = TRUE)

# Categorization of other Education Variables
joined_dataset$highschool_category <- cut(joined_dataset$years25_onlyhighschool_2022, 
                                          breaks = quantile(joined_dataset$years25_onlyhighschool_2022, probs = seq(0, 1, 0.25), na.rm = TRUE), 
                                          labels = c("Low", "Medium", "High", "Very High"), 
                                          include.lowest = TRUE)

joined_dataset$bachelor_category <- cut(joined_dataset$years25_bachelor_2022, 
                                        breaks = quantile(joined_dataset$years25_bachelor_2022, probs = seq(0, 1, 0.25), na.rm = TRUE), 
                                        labels = c("Low", "Medium", "High", "Very High"), 
                                        include.lowest = TRUE)

joined_dataset$graduate_category <- cut(joined_dataset$years25_graduate_2022, 
                                        breaks = quantile(joined_dataset$years25_graduate_2022, probs = seq(0, 1, 0.25), na.rm = TRUE), 
                                        labels = c("Low", "Medium", "High", "Very High"), 
                                        include.lowest = TRUE)

# Categorization of overdoses
joined_dataset$overdose_category <- cut(joined_dataset$overdose_deaths, 
                                        breaks = c(200, 1000, 3000, 5000, 8000, 11000), 
                                        labels = c("200-1000", "1001-3000", "3001-5000", "5001-8000", "8001-11000"), 
                                        include.lowest = TRUE)
```

Once we categorized all our variables, we create contingency table to explore the relationship between each categorical variable and the overdoses_deaths variables through a contingency table.

```{r}
library(kableExtra)

# We create unique contingency table for all the variables of educations VS Overdose deaths  
contingency_table <- data.frame(
  "Overdose Category" = joined_dataset$overdose_category,
  "Less Highschool" = joined_dataset$less_highschool_category,
  "Highschool" = joined_dataset$highschool_category,
  "Bachelor" = joined_dataset$bachelor_category,
  "Graduate" = joined_dataset$graduate_category
)

# Initialisation of the results
results <- data.frame(
  Variable = c("Less Highschool", "Highschool", "Bachelor", "Graduate"),
  Chi_Square = numeric(4),
  DF = integer(4),
  P_Value = numeric(4)
)

# For each variable of education we do the Chi squared test 
for (i in 2:ncol(contingency_table)) {
  contingency <- table(contingency_table[, i], contingency_table$Overdose.Category)
  chisq_test <- chisq.test(contingency)
  
  results$Chi_Square[i - 1] <- chisq_test$statistic
  results$DF[i - 1] <- chisq_test$parameter
  results$P_Value[i - 1] <- chisq_test$p.value
}

# Results using Kable
results %>%
  kbl(caption = "Chi-Squared Test Results for Education Variables vs Overdose Categories",
      col.names = c("Variable", "Chi-Square", "Degrees of Freedom (DF)", "P-Value"),
      align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE) %>%
  column_spec(1, bold = TRUE, color = "black", background = "#f7f7f7") %>%
  column_spec(4, color = ifelse(results$P_Value < 0.05, "red", "black")) %>%
  add_footnote("P-Values in red indicate statistical significance at the 0.05 level.")
```

-   **Comments:**

    The results of the Chi-square tests indicate the absence of statistically significant relationships between levels of education (Less Highschool, Highschool, Bachelor, Graduate) and categories of overdose deaths in the different states. The p-values for all educational variables (0.229, 0.158, 0.205, and 0.517 respectively) are above the level of 0.05, suggesting that we cannot reject the null hypothesis H0 of independence between these variables. In other words, differences in the proportions of overdose deaths don't vary significantly according to education levels.

    Regarding the State variable, the Chi-square test shows a p-value of 0.327, also above the 0.05 significance level. Again, this means that there is no significant relationship between states and overdose categories. This observation could indicate that regional disparities are not sufficiently marked, or that differences in overdoses are influenced by other factors not included in this analysis.

    These results raise questions about the real influence of education levels on the fentanyl overdose crisis. Although education is often perceived as a protective factor, these results do not show a statistically significant association. This could be explained by some factors such as limited data but also confounding factors, for instance, health access, economic conditions...

<!-- -->

-   **The Student test:**

Our second test is the Student test. This t-statistic test allows us to measure the difference between the observed mean and μ adjusted by standard deviation and sample size. Here, we do the 2 Sample t-test, which essentially compares overdose deaths and highschool category. Our hypothesis is as follows:

**Null hypothesis (**H0​): The means of overdose deaths for the “Low” and “Very High” groups (based on highschool_category) are equal. In other words, H0 μLow = μ Very High **≠**

**Alternative hypothesis (**H1​): The means of overdose deaths for the two groups are different. Therefore: H1: μ Low **≠** μ Very High

```{r}
# Charger kableExtra pour une meilleure présentation
library(kableExtra)

# Résultats du test T
t_test_results <- data.frame(
  Statistic = c("t-statistic", "Degrees of Freedom (df)", "P-Value", "Confidence Interval (95%)", "Mean (Low)", "Mean (Very High)"),
  Value = c(1.4454, 3.6066, 0.2293, "[-3171.294, 9473.294]", 4723, 1572)
)

# Générer un tableau stylisé avec kable
t_test_results %>%
  kbl(caption = "Welch Two Sample t-Test Results: Highschool Education Category vs Overdose Deaths",
      col.names = c("Metric", "Value"),
      align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE) %>%
  column_spec(1, bold = TRUE, color = "black",background = "#f7f7f7") %>%
  column_spec(2, color = ifelse(t_test_results$Statistic == "P-Value" & t_test_results$Value < 0.05, "red", "black")) %>%
  add_footnote("P-Value greater than 0.05 indicates no statistically significant difference.")

```

-   **Comments:**

    Welch's t-test compares overdose deaths between the "Low" and "Very High" groups according to secondary education level. The results show a higher average for the "Low" group (4723 deaths) compared to the "Very High" group (1572 deaths). However, this difference is not statistically significant (p=0.2293), as also indicated by the wide confidence interval (-3171.294, 9473.294), which includes 0. This reflects high variability in the data and a limited sample, reducing the ability to detect a significant difference.

Graphically we get

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Filter the data for the relevant groups
low_group <- joined_dataset %>% filter(highschool_category == "Low") %>% select(overdose_deaths)
very_high_group <- joined_dataset %>% filter(highschool_category == "Very High") %>% select(overdose_deaths)

# Combine the groups into a single dataframe with an indicator
plot_data <- data.frame(
  overdose_deaths = c(low_group$overdose_deaths, very_high_group$overdose_deaths),
  group = c(rep("Low", nrow(low_group)), rep("Very High", nrow(very_high_group)))
)

# Calculate means for each group
mean_low <- mean(low_group$overdose_deaths, na.rm = TRUE)
mean_very_high <- mean(very_high_group$overdose_deaths, na.rm = TRUE)

# Create the density plot
ggplot(plot_data, aes(x = overdose_deaths, fill = group)) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = mean_low, color = "red", linetype = "dashed", size = 1) +
  geom_vline(xintercept = mean_very_high, color = "blue", linetype = "dashed", size = 1) +
  annotate("text", x = mean_low, y = 0.0001, label = paste("Mean (Low) =", round(mean_low, 2)),
           color = "red", hjust = -0.1) +
  annotate("text", x = mean_very_high, y = 0.0001, label = paste("Mean (Very High) =", round(mean_very_high, 2)),
           color = "blue", hjust = 1.2) +
  labs(
    title = "Density Plot of Overdose Deaths by Highschool Education Level",
    x = "Overdose Deaths",
    y = "Density"
  ) +
  scale_fill_manual(values = c("red", "blue")) +
  theme_minimal() +
  theme(legend.title = element_blank(), legend.position = "top")

```
-   **Comments:**

    The density graph clearly illustrates the differences in the distribution of overdose deaths between the "Low" and "Very High" groups. The distribution of deaths for the "Low" group is wider and shows a higher mean (4723) than that of the "Very High" group (1572). However, superposition of the distributions indicates high variability in both groups.

2.  Adjustement measures:
```{r}
# Extract the model summary
model_summary <- summary(regression_model)

# Extract key statistics
residual_se <- model_summary$sigma  # Residual standard error
r_squared <- model_summary$r.squared  # Multiple R-squared
adjusted_r_squared <- model_summary$adj.r.squared  # Adjusted R-squared
f_statistic <- model_summary$fstatistic  # F-statistic
f_value <- f_statistic[1]  # F-statistic value
df1 <- f_statistic[2]  # Degrees of freedom for numerator
df2 <- f_statistic[3]  # Degrees of freedom for denominator
p_value <- pf(f_value, df1, df2, lower.tail = FALSE)  # p-value for F-statistic

# Create a summary table
summary_table <- data.frame(
  Metric = c("Residual Standard Error", 
             "Multiple R-squared", 
             "Adjusted R-squared", 
             "F-statistic",
             "p-value"),
  Value = c(round(residual_se, 4), 
            round(r_squared, 4), 
            round(adjusted_r_squared, 4), 
            paste(round(f_value, 2), "on", df1, "and", df2, "DF"),
            format(p_value, scientific = TRUE))
)

# Convert to HTML using kableExtra
library(kableExtra)
kable(summary_table, format = "html", align = "c", caption = "Model Fit Statistics") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F, font_size = 14) %>%
  column_spec(1, bold = T, color = "black", background = "#f7f7f7") %>%
  row_spec(0, bold = T, background = "#D3D3D3")

```
-   **Comments:**

    The statistics of our regression model show a high residual standard error (2187.4975), indicating significant variability in the model's predictions. The multiple R-squared of 0.7298 suggests that 72.98% of the variance in overdose deaths is explained by the included independent variables. However, the R-squared adjustment, at 0.4146, reveals that after adjusting for the number of predictors, the explanatory power of the model is reduced, thus highlighting a potential over-fitting or low robustness. The F-statistic analysis (2.32 with 7 and 6 degrees of freedom) is not significant (p = 0.1629627), indicating that the model as a whole does not significantly explain the variance in deaths. These results suggest that, although some relationships may exist, the model is not entirely reliable and may require improvements, such as the inclusion of additional variables.
    
## Conclusion
